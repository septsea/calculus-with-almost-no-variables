\documentclass[UTF8,fontset=none,zihao=-4,a4paper,leqno]{ctexbook}

% Add "pass" to retain the old page margin settings
\usepackage[pass]{geometry}

% Load "imakeidx" (or "makeidx") before "hyperref"
\usepackage{imakeidx}
\makeindex[intoc]

\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{mathtools}
\usepackage{thmtools}
\usepackage{thm-restate}
\usepackage[hidelinks,hyperindex,breaklinks]{hyperref}
% Add hyperlinks to the table of contents
\usepackage{bookmark}
% partial=upright makes \partial stand up
\usepackage[math-style=ISO,bold-style=ISO,mathrm=sym,mathbf=sym,partial=upright,warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\setlength{\headheight}{15pt}
\fancyhead[LO]{\sffamily\nouppercase{\rightmark}}
\fancyhead[RO]{\sffamily\thepage}
\fancyhead[RE]{\sffamily\nouppercase{\leftmark}}
\fancyhead[LE]{\sffamily\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\fancypagestyle{plain}{%
    \fancyhf{}
    \fancyfoot[C]{\sffamily\thepage}
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
}

\allowdisplaybreaks[3]
\AtBeginDocument{
    \def\UrlFont{\ttfamily}

    \let\umathpi\pi
    \renewcommand\pi{\symup\umathpi}
    \let\umathiota\iota
    \renewcommand\iota{\symup\umathiota}

    \renewcommand\leq{\leqslant}
    \renewcommand\geq{\geqslant}
    \renewcommand\mathellipsis{\cdots}
}

\usepackage{enumitem}
\setlist[1]{labelindent=\parindent}
\setlist[itemize]{leftmargin=*,nosep}
\setlist[enumerate]{leftmargin=*,nosep}
\setlist[enumerate,1]{label=(\arabic*),ref=(\arabic*)}
\setlist[description]{style=nextline,leftmargin=2\parindent}

\declaretheoremstyle[
    spaceabove=2ex,
    spacebelow=2ex,
    headfont=\normalfont\bfseries,
    notefont=\mdseries,
    notebraces={(}{)},
    bodyfont=\normalfont,
    headindent=\parindent,
    headpunct={},
    postheadspace=1em
]{TheoremStyle}

\declaretheoremstyle[
    spaceabove=2ex,
    spacebelow=2ex,
    headfont=\normalfont\bfseries,
    notefont=\mdseries,
    notebraces={(}{)},
    bodyfont=\normalfont,
    headindent=\parindent,
    headpunct={},
    postheadspace=1em,
    qed=\qedsymbol
]{ProofStyle}

\declaretheorem[style=TheoremStyle,name=定理,numberwithin=chapter]{theorem}
\declaretheorem[style=TheoremStyle,name=定义,sibling=theorem]{definition}
\declaretheorem[style=TheoremStyle,name=定义,numbered=no]{definition*}
\declaretheorem[style=TheoremStyle,name=命题,sibling=theorem]{proposition}
\declaretheorem[style=TheoremStyle,name=引理,sibling=theorem]{lemma}
\declaretheorem[style=TheoremStyle,name=公理,sibling=theorem]{axiom}
\declaretheorem[style=TheoremStyle,name=推论,sibling=theorem]{corollary}
\declaretheorem[style=TheoremStyle,name=例,sibling=theorem]{example}
\declaretheorem[style=TheoremStyle,name=注,sibling=theorem]{remark}
\declaretheorem[style=TheoremStyle,name=注,numbered=no]{remark*}
\declaretheorem[style=TheoremStyle,name=猜想,sibling=theorem]{conjecture}

% Undefine the proof environment provided by `amsthm`
\makeatletter
\let\proof\@undefined
\let\endproof\@undefined
\makeatother
\declaretheorem[style=ProofStyle,name=证,numbered=no]{proof}
\def\qedsymbol{证毕.}

\let\emph\relax
\DeclareTextFontCommand{\emph}{\bfseries}

% Punctuation style: narrow some punctuation symbols
\punctstyle{kaiming}

\usepackage[backend=biber,style=gb7714-2015]{biblatex}
\addbibresource{bibliography.bib}

\setmainfont{XITS}
% Standing-up-straight integral symbol (For XITS Math)
\setmathfont{XITS Math}[StylisticSet=8]
\setmathfont{TeX Gyre Termes Math}[range=bb/{latin,Latin}]
\setmathfont{STIX Two Math}[range={"2218-"2218}]
\setsansfont{Fira Sans}[
    UprightFont = * Light,
    BoldFont = * SemiBold,
    ItalicFont = * Light Italic,
    BoldItalicFont = * SemiBold Italic,
]
\setmonofont{Sarasa Mono SC}[
    UprightFont = * Light,
    BoldFont = * Semibold,
    ItalicFont = * Light Italic,
    BoldItalicFont = * Semibold Italic,
]

\setCJKmainfont{Source Han Serif CN}[
    UprightFont = Source Han Serif CN,
    BoldFont = Sarasa Mono SC Semibold,
    ItalicFont = Sarasa Mono SC Light Italic,
    BoldItalicFont = Sarasa Mono SC Semibold Italic,
]
\setCJKsansfont{Sarasa Mono SC}[
    UprightFont = * Light,
    BoldFont = * Semibold,
    ItalicFont = * Light Italic,
    BoldItalicFont = * Semibold Italic,
]
\setCJKmonofont{Sarasa Mono SC}[
    UprightFont = * Light,
    BoldFont = * Semibold,
    ItalicFont = * Light Italic,
    BoldItalicFont = * Semibold Italic,
]

% The following code makes it easier to input a version number
% converging to 2pi.
%
% Usage: \CalculusVersion[n], where n is a positive integer
% less than 1100.
\usepackage{readarray}
\readrecordarray{ApproximationsTo2Pi.txt}\CalculusVersion

% Well, whatever.
\usepackage{ifthen}
